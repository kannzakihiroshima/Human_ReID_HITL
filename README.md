# Human_ReID_HITL

これまでに著者らは，複数地点に設置したカメラで観測した歩行者画像から歩行者ODを推定するために，画像内の人物を個人レベルで特定するPerson Re-Identification (ReID) 手法を開発してきた．本研究ではReID技術の精度向上に向けたHuman in the Loop型アノテーション手法を提案する．本研究は，人物特徴量を分離する初期モデルの構築，アノテーション候補の探索と人手によるアノテーション，モデルの再学習の３段階のプロセスに基づく．実験では，MARSデータセットを用いてHITL型のアノテーション効率の検証を行う．

![image](https://github.com/user-attachments/assets/2da8fa5a-243a-4bf0-8cb8-a94b533cdac4)

## ディレクトリ構造

my_project/
└──MARS/
   ├── all_mini_direct/
   │     ├──train_split_ReSNet_pkl/
   │     ├──gallery_split_ReSNet_pkl/
   │     ├──query_split_ReSNet_pkl/
   ├── bbox_test/
   │     ├──bbox_test/
   │     ├──gallery_files.txt
   │     ├──gallery_skipped_files.txt
   │     ├──query_files.txt
   │     ├──query_IDX.mat
   │     ├──test_name.txt
   │     ├──tracks_test_info.mat
   ├── bbox_train/
   　     └──bbox_train/

bbox_test, bbox_trainの直下にMARSデータセットのtest,trainのbboxデータを置いてください．

## ファイル説明
### MARS_deal.ipynb
このコードでは，MARSデータセットにおける，train,gallery,queryの画像に対して学習済みReSNet-50（MSMT17で事前学習）を適用して，各画像の外観特徴量を抽出する．
注意事項は以下の通り．
- pid=0，pid=-1は背景画像，または対象外の人物画像のため，本実験ではpid=0,-1を除外している．（def _process_data()）
- 本コードの実装環境において，メモリの限界があったため，train,gallery,queryの外観特徴量を小分けにしてpklファイルに保存している
  
### train_predict.ipynb
このコードでは，外観特徴量を抜き出した7人のトラクレットを識別することに特化した外観特徴量に変換する．その後，探索データセットにおいて，その7人を探し出す作業を行う．また探索結果を人間の目で確認し，再度外観特徴量変換モデルを学習し，7人を探す作業を繰り返す．この一連の作業を抜き出す7人のトラクレットを変更しながら繰り返し行う．
注意事項は以下の通り
- 本コードにおける機械学習はpytorchで行われる．特に損失関数にはpytorch_metric_learningのArcFaceLossを改良したものを使用している．具体的には学習時におけるクラス間のサンプルに重みをSoftmax部分に適用することにより，クラス間のサンプル数の違いに対処している．
- また，今回のコードではHITLの人間がアノテーションをする部分を疑似的に行っている．具体的にはアノテーション対象として抜き出したトラクレットに対して，内部プログラムで正解ラベルを参照しながらアノテーションを自動的に行っている．（本当はここは人間が行うところである）


## 未検討課題
- 抜き出した７人分のトラクレットにはpidが同一のものが被らないということを前提にしている．本コードでは正解pidを参照しながらランダムに７人分のトラクレットを抜き出している．しかし，pidが事前に知りえない本番環境では本コードの処理は不可能で，７人のトラクレットに同一のpidが混在する可能性がある．これを対策する処理が必要であると考えられる．
- 抜き出すトラクレットの数は7つでいいのか，それとももっと多い人数がいいのか，また抜き出す7人の組み合わせはどれがいいのか（できるだけ似た人を集めたほうがいい？似ていない多様性のある人を選んだ方がいい？）検証する必要がある
- HITLの再学習プロセスにおいて，毎回外観特徴量変換モデルの全結合層の重みは初期化している．この時，重みは初期化するのか，前回の重みを用いるのかどちらがいいかわからない
- 本研究では，抜き出す7人を変更した外観特徴量変換モデルが多数生成される．現在，各モデルは，自身のモデルの結果しか参照していない．しかし，多数あるモデルの結果を相互に確認することで，アンサンブル結果を用いてReID精度が向上するのではないか．
